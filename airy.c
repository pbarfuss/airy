/* Author:  G. Jungman */
#include <stdint.h>
#include <math.h>
#include <errno.h>
#define DBL_EPSILON 0x1p-52
#define DBL_2EPSILON 0x1p-51

static double ath0cs[53] = { 
    -0.08172601764161634499840208700543,
    -8.004012824788273287596481113068e-4,
    -3.186525268782113203795553628242e-6,
    -6.688388266477509330741698865033e-8,
    -2.931759284994564516506822463184e-9,
    -2.011263760883621669049030307186e-10,
    -1.877522678055973426074008166652e-11,
    -2.199637137704601251899002199848e-12,
    -3.071616682592272449025746605586e-13,
    -4.936140553673418361025600985389e-14,
    -8.902833722583660416935236969866e-15,
    -1.768987764615272613656814199467e-15,
    -3.8178686890322770146781996096e-16,
    -8.851159014819947594156286509984e-17,
    -2.184818181414365953149677679568e-17,
    -5.700849046986452380599442295119e-18,
    -1.563121122177875392516031795495e-18,
    -4.481437996768995067906688776353e-19,
    -1.337794883736188022044566044098e-19,
    -4.143340036874114453776852445442e-20,
    -1.327263385718805025080481164652e-20,
    -4.385728589128440522215756835955e-21,
    -1.491360695952818067686201743956e-21,
    -5.208104738630711377154238188773e-22,
    -1.864382222390498923872526604979e-22,
    -6.830263751167969012975435381881e-23,
    -2.557117058029329629296207591347e-23,
    -9.770158640254300218246907254046e-24,
    -3.805161433416679084068428254886e-24,
    -1.509022750737054063493926482995e-24,
    -6.087551341242424929005568014525e-25,
    -2.495879513809711495425982124058e-25,
    -1.039157654581920948909588084274e-25,
    -4.390235913976846536974594969051e-26,
    -1.880790678447990211675826820582e-26,
    -8.165070764199462948863022205753e-27,
    -3.589944503749750514266435585041e-27,
    -1.597658126632132872981291608708e-27,
    -7.193250175703823969113802835305e-28,
    -3.274943012727856506209351132721e-28,
    -1.507042445783690665816975047272e-28,
    -7.00662419831990471784396794914e-29,
    -3.289907402983718226528815678356e-29,
    -1.559518084365146526445322711496e-29,
    -7.460690508208254582833851119721e-30,
    -3.600877034824662020563277249431e-30,
    -1.752851437473772257350402219197e-30,
    -8.603275775188512909623778628724e-31,
    -4.256432603226946534668039480105e-31,
    -2.122161865044262927723650698206e-31,
    -1.065996156704879052472060798561e-31,
    -5.393568608816949116410688086892e-32,
    -2.74817485104395482227849651787e-32
};

static double ath1_data[36] = {
  -0.07125837815669365,
  -0.00590471979831451,
  -0.00012114544069499,
  -0.00000988608542270,
  -0.00000138084097352,
  -0.00000026142640172,
  -0.00000006050432589,
  -0.00000001618436223,
  -0.00000000483464911,
  -0.00000000157655272,
  -0.00000000055231518,
  -0.00000000020545441,
  -0.00000000008043412,
  -0.00000000003291252,
  -0.00000000001399875,
  -0.00000000000616151,
  -0.00000000000279614,
  -0.00000000000130428,
  -0.00000000000062373,
  -0.00000000000030512,
  -0.00000000000015239,
  -0.00000000000007758,
  -0.00000000000004020,
  -0.00000000000002117,
  -0.00000000000001132,
  -0.00000000000000614,
  -0.00000000000000337,
  -0.00000000000000188,
  -0.00000000000000105,
  -0.00000000000000060,
  -0.00000000000000034,
  -0.00000000000000020,
  -0.00000000000000011,
  -0.00000000000000007,
  -0.00000000000000004,
  -0.00000000000000002
};

static double ath2_data[32] = {
   0.00440527345871877,
  -0.03042919452318455,
  -0.00138565328377179,
  -0.00018044439089549,
  -0.00003380847108327,
  -0.00000767818353522,
  -0.00000196783944371,
  -0.00000054837271158,
  -0.00000016254615505,
  -0.00000005053049981,
  -0.00000001631580701,
  -0.00000000543420411,
  -0.00000000185739855,
  -0.00000000064895120,
  -0.00000000023105948,
  -0.00000000008363282,
  -0.00000000003071196,
  -0.00000000001142367,
  -0.00000000000429811,
  -0.00000000000163389,
  -0.00000000000062693,
  -0.00000000000024260,
  -0.00000000000009461,
  -0.00000000000003716,
  -0.00000000000001469,
  -0.00000000000000584,
  -0.00000000000000233,
  -0.00000000000000093,
  -0.00000000000000037,
  -0.00000000000000015,
  -0.00000000000000006,
  -0.00000000000000002
};

static inline double 
cheb_eval(double *cs, int order, double y)
{
  double d  = 0.0, dd= 0.0, y2 = y + y;
  int j;
  for(j = order; j>=1; j--) {
    double temp = d;
    d = y2*d - dd + cs[j];
    dd = temp;
  }
  d = y*d - dd + 0.5 * cs[0];
  return d;
}

/* Airy phase for x < -1 */
static double airy_phase(double x, unsigned int mode)
{
  double p, ph, sqx;
  if(x < -2.0) {
    double z = 16.0/(x*x*x) + 1.0;
    ph = cheb_eval(ath1_data, mode ? 35 : 15, z);
  } else if(x <= -1.0) {
    double z = (16.0/(x*x*x) + 9.0)/7.0;
    ph = cheb_eval(ath2_data, mode ? 31 : 16, z);
  } else {
    ph = 0.0;
  }
  p = -0.625 + ph;
  sqx = sqrt(-x);
  return M_PI_4 - x*sqx*p;
}

/* Chebyshev expansion for Airy modulus

 Series for AM21       on the interval -1.25000D-01 to  0.
                                        with weighted error   2.89E-17
                                         log weighted error  16.54
                               significant figures required  14.15
                                    decimal places required  17.34
*/

static double am21_data[37] = {
  0.0065809191761485,
  0.0023675984685722,
  0.0001324741670371,
  0.0000157600904043,
  0.0000027529702663,
  0.0000006102679017,
  0.0000001595088468,
  0.0000000471033947,
  0.0000000152933871,
  0.0000000053590722,
  0.0000000020000910,
  0.0000000007872292,
  0.0000000003243103,
  0.0000000001390106,
  0.0000000000617011,
  0.0000000000282491,
  0.0000000000132979,
  0.0000000000064188,
  0.0000000000031697,
  0.0000000000015981,
  0.0000000000008213,
  0.0000000000004296,
  0.0000000000002284,
  0.0000000000001232,
  0.0000000000000675,
  0.0000000000000374,
  0.0000000000000210,
  0.0000000000000119,
  0.0000000000000068,
  0.0000000000000039,
  0.0000000000000023,
  0.0000000000000013,
  0.0000000000000008,
  0.0000000000000005,
  0.0000000000000003,
  0.0000000000000001,
  0.0000000000000001
};

static void Ai_Bi_series(double x, double *ai, double *bi)
{
    double x3, xn, c1, c2, r1, r2, fx, gx, comp1, comp2;
    unsigned int k, km = ((fabs(x) >= 2.0) ? 17 : 13);

    c1 = 0.355028053887817;
    c2 = 0.258819403792807;
    x3 = (x * x * x)/3.0;
	r1 = xn = 1.0;
	r2 = x;
    fx = gx = comp1 = comp2 = 0.0;
    if (fabs(x) > 4.0) km += (km>>1);
	for (k = 1; k < km; ++k) {
        double k3 = (double)(3*k);
        double fx_ = fx, gx_ = gx;
	    r1 = r1 * (1.0 / k * 1.0 / (k3 - 1.0));
	    r2 = r2 * (1.0 / k * 1.0 / (k3 + 1.0));
        xn *= x3;
	    //fx += xn*r1;
	    //gx += xn*r2;
	    fx += (xn*r1 + comp1);
        comp1 += (fx_ - fx) + xn*r1;
	    gx += (xn*r2 + comp2);
        comp2 += (gx_ - gx) + xn*r2;
	}
	*ai = (c1 * fx - c2 * gx) + (c1 - c2*x);
    *bi = (c1 * fx + c2 * gx) + (c1 + c2*x);
}

/* assumes x < -2.0 */
static inline double
airy_modulus(double x)
{
  double m, sqx = sqrt(-x), z = 1.0/(x*x*x);
  if (x < -8.0) {
      z = 0.03125*z; 
      m = M_1_PI*(1.0 + 5.0*z*(1.0 + 77*0.5*z*(3.0 + 1105*z*(1 + 3059*0.25*z*(1 + 1015*z)))));
  } else {
      m = 0.3125 + cheb_eval(am21_data, 20, 16*z+1.0); /* 20 */
  }
  return sqrt(m/sqx);
}

double Aie(double x)
{
    const double rp = 0.5641895835477563;
    unsigned long k, km;
    double r=1, r1=1, xa, xq, xr1, sai;

    xa = 1.0 / fabs(x);
    xq = sqrt(xa);
    xr1 = xa * xq * 1.5;
    if (x > 14.0) {
        km = 4;
    } else if (x > 10.0) {
        km = 6;
    } else {
        km = lrint(15.0 - x);
    }
    sai = 1.0;
    for (k = 1; k < km; ++k) {
        double t = (((k * 6.0) - 1.0) * ((k * 6.0) - 5.0)) / (k * 72.0);
        r1 *= xr1;
        r1 = -r1;
        r = r * t;
        sai += r * r1;
    }
    sai = 0.5 * sqrt(xq) * rp * sai;
    return sai;
}

double Ai(double x, unsigned int mode)
{
  double val;
  if(x < -5.0) {
    double theta = airy_phase (x, mode);
    double cos_result = cos(theta);
    val  = airy_modulus(x) * cos_result;
  } else if(x < 2.0) {
    double bi;
    Ai_Bi_series(x,&val,&bi);
  } else {
    double x32 = x0 * sqx;
    val = Aie(x);
    //if (x < 3.0) {
        double s = exp(-2.0/(3.0*x32));
        val *= s;
    //}
  }
  return val;
}

